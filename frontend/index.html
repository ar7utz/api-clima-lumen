<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <title>API de Clima</title>
</head>
<body class="bg-blue-200">
    <div class="flex flex-row items-center justify-start p-2 w-50">
        <!-- Clima Atual -->
        <div id="clima-atual" class="bg-white p-6 rounded-lg shadow-lg text-center mb-4 w-96 h-60">
            <h1 class="text-xl font-bold">Clima Atual</h1>
            <p id="localizacao" class="text-gray-500 mb-2">Obtendo sua localiza√ß√£o...</p>
            <div id="resultado-local" class="mt-2"></div>
        </div>
    </div>

    <div class="flex flex-row items-center justify-center space-x-4">
        <!-- Pesquisa de clima por cidade -->
        <div id="pesquisa-clima" class="bg-white p-6 rounded-lg shadow-lg text-center w-96 h-80">
            <h1 class="text-xl font-bold">Pesquisar Clima</h1>
            <input id="cidade" type="text" placeholder="Digite o nome da cidade" class="border p-2 w-full mt-4 mb-4" oninput="buscarSugestoes()">
            <ul id="sugestoes" class="text-left border bg-white max-h-40 overflow-y-auto"></ul>
            <div id="resultado-cidade" class="mt-4"></div>
        </div>

        <!-- Previs√£o de 7 Dias -->
        <div id="previsao-7-dias" class="bg-white p-6 rounded-lg shadow-lg text-center w-96 h-80">
            <h1 class="text-xl font-bold mb-6">Previs√£o para os Pr√≥ximos 7 Dias</h1>
            <div id="previsao-container" class="flex gap-4 mt-4 overflow-x-auto"></div>
            <div id="botoes-navegacao" class="flex justify-between mt-4 hidden">
                <button id="prev-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg">Anterior</button>
                <button id="next-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg">Pr√≥ximo</button>
            </div>
        </div>

        <!-- Compara√ß√£o de Temperaturas -->
        <div id="comparacao-temperaturas" class="bg-white p-6 rounded-lg shadow-lg text-center w-96 h-80">
            <h1 class="text-xl font-bold">Compara√ß√£o de Temperaturas</h1>
            <div id="comparacao-container" class="mt-4"></div>
        </div>
    </div>


    <script>
        const weatherDescriptions = {
            0: "C√©u limpo",
            1: "Principalmente limpo",
            2: "Parcialmente nublado",
            3: "Nublado",
            45: "Nevoeiro",
            48: "Nevoeiro com geada",
            51: "Chuvisco leve",
            53: "Chuvisco moderado",
            55: "Chuvisco intenso",
            61: "Chuva leve",
            63: "Chuva moderada",
            65: "Chuva forte",
            80: "Pancadas de chuva leves",
            81: "Pancadas de chuva moderadas",
            82: "Pancadas de chuva fortes",
        };

        // Fun√ß√£o para obter a localiza√ß√£o do usu√°rio
        function obterLocalizacao() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;

                        if (!lat || !lon) {
                            console.error('Coordenadas inv√°lidas recebidas do navegador.');
                            document.getElementById('localizacao').innerText = 'N√£o foi poss√≠vel obter sua localiza√ß√£o.';
                            return;
                        }

                        // Chama as fun√ß√µes para buscar os dados com base na localiza√ß√£o
                        buscarClima(lat, lon, "resultado-local", true);
                        buscarPrevisao(lat, lon); // Adiciona a previs√£o de 7 dias
                    },
                    (error) => {
                        console.error('Erro ao obter localiza√ß√£o:', error);
                        document.getElementById('localizacao').innerText = 'N√£o foi poss√≠vel obter sua localiza√ß√£o.';
                    }
                );
            } else {
                document.getElementById('localizacao').innerText = 'Geolocaliza√ß√£o n√£o √© suportada pelo seu navegador.';
            }
        }

        // Fun√ß√£o para buscar sugest√µes de cidades
        function buscarSugestoes() {
            let cidade = document.getElementById('cidade').value;

            if (cidade.length < 2) {
                document.getElementById('sugestoes').innerHTML = '';
                return;
            }

            fetch(`/api/sugestoes?query=${cidade}`)
                .then(res => res.json())
                .then(data => {
                    if (data.length === 0) {
                        document.getElementById('sugestoes').innerHTML = '<li class="p-2 text-gray-500">Nenhuma cidade encontrada.</li>';
                        return;
                    }

                    let sugestoesHTML = data.map(cidade => `
                        <li class="p-2 cursor-pointer hover:bg-blue-100"
                            onclick="selecionarCidade(${cidade.lat}, ${cidade.lon}, '${cidade.name}', '${cidade.state || ''}', '${cidade.country}')">
                            ${cidade.name}, ${cidade.state || ''}, ${cidade.country}
                        </li>
                    `).join('');
                    document.getElementById('sugestoes').innerHTML = sugestoesHTML;
                })
                .catch(err => {
                    console.error("Erro ao buscar sugest√µes:", err);
                    document.getElementById('sugestoes').innerHTML = '<li class="p-2 text-red-500">Erro ao buscar sugest√µes.</li>';
                });
        }

        // Fun√ß√£o para selecionar uma cidade
        function selecionarCidade(lat, lon, nome, estado, pais) {
            document.getElementById('cidade').value = `${nome}, ${estado}, ${pais}`;
            document.getElementById('sugestoes').innerHTML = '';
            buscarClima(lat, lon, "resultado-cidade");
            buscarPrevisao(lat, lon);
            buscarComparacao(lat, lon);
        }

        // Fun√ß√£o para buscar o clima atual
        async function buscarClima(lat, lon, resultadoId, isLocal = false) {
            if (!lat || !lon) {
                console.error('Coordenadas inv√°lidas fornecidas para buscarClima.');
                document.getElementById(resultadoId).innerHTML = `<p class="text-red-500">Erro: Coordenadas inv√°lidas.</p>`;
                return;
            }

            try {
                let resposta = await fetch(`http://localhost:8000/api/clima-atual?lat=${lat}&lon=${lon}`);

                if (!resposta.ok) {
                    throw new Error(`Erro na requisi√ß√£o: ${resposta.status} ${resposta.statusText}`);
                }

                let dados = await resposta.json();

                if (dados.error) {
                    throw new Error(dados.error);
                }

                const descricao = weatherDescriptions[dados.weathercode] || "Condi√ß√£o desconhecida";

                if (isLocal) {
                    document.getElementById('localizacao').innerText = `Clima Atual para sua localiza√ß√£o`;
                }

                // Atualiza o elemento com os dados do clima
                document.getElementById(resultadoId).innerHTML = `
                    <div class="p-4 bg-gray-100 rounded-lg h-full flex flex-col justify-center">
                        <p><strong>Temperatura:</strong> ${dados.temperature}¬∞C</p>
                        <p><strong>Velocidade do Vento:</strong> ${dados.windspeed} km/h</p>
                        <p><strong>Dire√ß√£o do Vento:</strong> ${dados.winddirection}¬∞</p>
                        <p><strong>Condi√ß√£o:</strong> ${descricao}</p>
                    </div>`;
            } catch (error) {
                console.error('Erro ao buscar o clima:', error);
                document.getElementById(resultadoId).innerHTML = `<p class="text-red-500">Erro ao buscar o clima: ${error.message}</p>`;
            }
        }

        // Fun√ß√£o para buscar a previs√£o de 7 dias
        async function buscarPrevisao(lat, lon) {
            if (!lat || !lon) {
                console.error('Coordenadas inv√°lidas fornecidas para buscarPrevisao.');
                document.getElementById('previsao-container').innerHTML = `<p class="text-red-500">Erro: Coordenadas inv√°lidas.</p>`;
                return;
            }

            try {
                let resposta = await fetch(`http://localhost:8000/api/previsao?lat=${lat}&lon=${lon}`);
                let dados = await resposta.json();

                if (dados.error) {
                    throw new Error(dados.error);
                }

                // Mapeia os c√≥digos de condi√ß√£o clim√°tica para √≠cones
                const weatherIcons = {
                    0: "‚òÄÔ∏è", // C√©u limpo
                    1: "üå§Ô∏è", // Principalmente limpo
                    2: "‚õÖ", // Parcialmente nublado
                    3: "‚òÅÔ∏è", // Nublado
                    45: "üå´Ô∏è", // Nevoeiro
                    48: "üå´Ô∏è‚ùÑÔ∏è", // Nevoeiro com geada
                    51: "üå¶Ô∏è", // Chuvisco leve
                    53: "üåßÔ∏è", // Chuvisco moderado
                    55: "üåßÔ∏è", // Chuvisco intenso
                    61: "üåßÔ∏è", // Chuva leve
                    63: "üåßÔ∏è", // Chuva moderada
                    65: "üåßÔ∏è", // Chuva forte
                    80: "üå¶Ô∏è", // Pancadas de chuva leves
                    81: "üå¶Ô∏è", // Pancadas de chuva moderadas
                    82: "üå¶Ô∏è", // Pancadas de chuva fortes
                };

                // Vari√°veis para o carrossel
                const diasPorPagina = 3;
                let paginaAtual = 0;

                // Fun√ß√£o para renderizar os dias no carrossel
                function renderizarPrevisao() {
                    const inicio = paginaAtual * diasPorPagina;
                    const fim = inicio + diasPorPagina;
                    const diasExibidos = dados.time.slice(inicio, fim);

                    const previsaoHTML = diasExibidos.map((dia, index) => `
                        <div class="p-2 bg-gray-100 rounded-lg flex flex-col items-center space-y-2 w-80 h-50">
                            <span class="text-3xl">${weatherIcons[dados.weathercode[inicio + index]] || "‚ùì"}</span>
                            <div class="align-middle items-center">
                                <p>${new Date(dia).toLocaleDateString('pt-BR')}</p>
                                <p>M√°x: ${dados.temperature_2m_max[inicio + index]}¬∞C</p>
                                <p>M√≠n: ${dados.temperature_2m_min[inicio + index]}¬∞C</p>
                            </div>
                        </div>
                    `).join('');

                    document.getElementById('previsao-container').innerHTML = previsaoHTML;

                    // Exibe os bot√µes de navega√ß√£o ap√≥s o carregamento
                    document.getElementById('botoes-navegacao').classList.remove('hidden');
                }

                // Fun√ß√£o para navegar para a p√°gina anterior
                document.getElementById('prev-btn').onclick = () => {
                    if (paginaAtual > 0) {
                        paginaAtual--;
                        renderizarPrevisao();
                    }
                };

                // Fun√ß√£o para navegar para a pr√≥xima p√°gina
                document.getElementById('next-btn').onclick = () => {
                    if ((paginaAtual + 1) * diasPorPagina < dados.time.length) {
                        paginaAtual++;
                        renderizarPrevisao();
                    }
                };

                // Renderiza a previs√£o inicial
                renderizarPrevisao();
            } catch (error) {
                console.error('Erro ao buscar a previs√£o:', error);
                document.getElementById('previsao-container').innerHTML = `<p class="text-red-500">Erro ao buscar a previs√£o.</p>`;
            }
        }

        // Fun√ß√£o para buscar a compara√ß√£o de temperaturas
        async function buscarComparacao(lat, lon) {
            if (!lat || !lon) {
                console.error('Coordenadas inv√°lidas fornecidas para buscarComparacao.');
                document.getElementById('comparacao-container').innerHTML = `<p class="text-red-500">Erro: Coordenadas inv√°lidas.</p>`;
                return;
            }

            try {
                let resposta = await fetch(`/api/comparar-temperatura?lat=${lat}&lon=${lon}`);
                let dados = await resposta.json();

                if (dados.error) {
                    throw new Error(dados.error);
                }

                document.getElementById('comparacao-container').innerHTML = `
                    <div class="p-4 bg-gray-100 rounded-lg h-full flex flex-col justify-center">
                        <p><strong>Ontem:</strong> ${dados.ontem}¬∞C</p>
                        <p><strong>Hoje:</strong> ${dados.hoje}¬∞C</p>
                        <p><strong>Diferen√ßa:</strong> ${dados.diferenca}¬∞C</p>
                    </div>`;
            } catch (error) {
                console.error('Erro ao buscar a compara√ß√£o de temperaturas:', error);
                document.getElementById('comparacao-container').innerHTML = `<p class="text-red-500">Erro ao buscar a compara√ß√£o de temperaturas.</p>`;
            }
        }

        // Inicializa a geolocaliza√ß√£o ao carregar a p√°gina
        window.onload = obterLocalizacao;
    </script>
</body>
</html>
