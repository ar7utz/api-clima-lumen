<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <title>API de Clima</title>
</head>
<body class="bg-blue-200">
    <div class="flex flex-row items-center justify-start p-2 w-50">
        <!-- Clima Atual -->
        <div id="clima-atual" class="bg-white p-2 rounded-lg shadow-lg text-center mb-2 w-80 h-3/4">
            <h1 class="text-xl font-bold">Clima Atual</h1>
            <p id="localizacao" class="text-gray-500 mb-2">Obtendo sua localiza√ß√£o...</p>
            <div id="resultado-local" class="mt-2"></div>
        </div>
    </div>

    <div class="flex flex-row items-center justify-center space-x-4">
        <!-- Pesquisa de clima por cidade -->
        <div id="pesquisa-clima" class="bg-white p-6 rounded-lg shadow-lg text-center w-96 h-96">
            <h1 class="text-xl font-bold">Pesquisar Clima</h1>
            <input id="cidade" type="text" placeholder="Digite o nome da cidade" class="border p-2 w-full mt-4 mb-4" oninput="buscarSugestoes()">
            <ul id="sugestoes" class="text-left border bg-white max-h-40 overflow-y-auto"></ul>
            <div id="resultado-cidade" class="mt-4"></div>
        </div>

        <!-- Previs√£o de 7 Dias -->
        <div id="previsao-7-dias" class="bg-white p-6 rounded-lg shadow-lg text-center w-96 h-96">
            <h1 class="text-xl font-bold mb-6">Previs√£o para os Pr√≥ximos 7 Dias</h1>
            <div id="previsao-container" class="flex gap-4 mt-4 overflow-x-auto"></div>
            <div id="botoes-navegacao" class="flex justify-between mt-4 hidden">
                <button id="prev-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg">Anterior</button>
                <button id="next-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg">Pr√≥ximo</button>
            </div>
        </div>

        <!-- Compara√ß√£o de Temperaturas -->
        <div id="comparacao-temperaturas" class="bg-white p-6 rounded-lg shadow-lg text-center w-96 h-96">
            <h1 class="text-xl font-bold">Compara√ß√£o de Temperaturas</h1>
            <div id="comparacao-container" class="mt-4"></div>
        </div>
    </div>


    <script>
        const weatherDescriptions = {
            0: "‚òÄÔ∏è C√©u limpo", // C√©u limpo
            1: "üå§Ô∏è Parcialmente limpo", // Principalmente limpo
            2: "‚õÖ Parcialmente nublado", // Parcialmente nublado
            3: "‚òÅÔ∏è Nublado", // Nublado
            45: "üå´Ô∏è Nevoeiro", // Nevoeiro
            48: "üå´Ô∏è‚ùÑÔ∏è Nevoeiro com geada", // Nevoeiro com geada
            51: "üå¶Ô∏è Chuvisco leve", // Chuvisco leve
            53: "üåßÔ∏è Chuvisco moderado", // Chuvisco moderado
            55: "üåßÔ∏è Chuvisco intenso", // Chuvisco intenso
            56: "üå®Ô∏è Chuvisco congelante leve", // Chuvisco congelante leve
            57: "üå®Ô∏è Chuvisco congelante intenso", // Chuvisco congelante intenso
            61: "üåßÔ∏è Chuva leve", // Chuva leve
            63: "üåßÔ∏è Chuva moderada", // Chuva moderada
            65: "üåßÔ∏è Chuva forte", // Chuva forte
            66: "üå®Ô∏è Chuva congelante leve", // Chuva congelante leve
            67: "üå®Ô∏è Chuva congelante forte", // Chuva congelante forte
            71: "‚ùÑÔ∏è Neve leve", // Neve leve
            73: "‚ùÑÔ∏è Neve moderada", // Neve moderada
            75: "‚ùÑÔ∏è Neve forte", // Neve forte
            77: "üå®Ô∏è Granizo", // Granizo
            80: "üå¶Ô∏è Pancadas de chuva leves", // Pancadas de chuva leves
            81: "üå¶Ô∏è Pancadas de chuva moderadas", // Pancadas de chuva moderadas
            82: "üå¶Ô∏è Pancadas de chuva fortes", // Pancadas de chuva fortes
            86: "‚ùÑÔ∏è Pancadas de neve fortes", // Pancadas de neve fortes
            95: "‚õàÔ∏è Tempestade leve ou moderada", // Tempestade leve ou moderada
            96: "‚õàÔ∏è Tempestade com granizo leve", // Tempestade com granizo leve
            99: "‚õàÔ∏è Tempestade com granizo forte", // Tempestade com granizo forte
        };

        const weatherIcons = {
            0: "‚òÄÔ∏è", // C√©u limpo
            1: "üå§Ô∏è", // Principalmente limpo
            2: "‚õÖ", // Parcialmente nublado
            3: "‚òÅÔ∏è", // Nublado
            45: "üå´Ô∏è", // Nevoeiro
            48: "üå´Ô∏è‚ùÑÔ∏è", // Nevoeiro com geada
            51: "üå¶Ô∏è", // Chuvisco leve
            53: "üåßÔ∏è", // Chuvisco moderado
            55: "üåßÔ∏è", // Chuvisco intenso
            56: "üå®Ô∏è", // Chuvisco congelante leve
            57: "üå®Ô∏è", // Chuvisco congelante intenso
            61: "üåßÔ∏è", // Chuva leve
            63: "üåßÔ∏è", // Chuva moderada
            65: "üåßÔ∏è", // Chuva forte
            66: "üå®Ô∏è", // Chuva congelante leve
            67: "üå®Ô∏è", // Chuva congelante forte
            71: "‚ùÑÔ∏è", // Neve leve
            73: "‚ùÑÔ∏è", // Neve moderada
            75: "‚ùÑÔ∏è", // Neve forte
            77: "üå®Ô∏è", // Granizo
            80: "üå¶Ô∏è", // Pancadas de chuva leves
            81: "üå¶Ô∏è", // Pancadas de chuva moderadas
            82: "üå¶Ô∏è", // Pancadas de chuva fortes
            85: "‚ùÑÔ∏è", // Pancadas de neve leves
            86: "‚ùÑÔ∏è", // Pancadas de neve fortes
            95: "‚õàÔ∏è", // Tempestade leve ou moderada
            96: "‚õàÔ∏è", // Tempestade com granizo leve
            99: "‚õàÔ∏è", // Tempestade com granizo forte
        };

        // Fun√ß√£o para obter a localiza√ß√£o do usu√°rio
        function obterLocalizacao() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;

                        if (!lat || !lon) {
                            console.error('Coordenadas inv√°lidas recebidas do navegador.');
                            document.getElementById('localizacao').innerText = 'N√£o foi poss√≠vel obter sua localiza√ß√£o.';
                            return;
                        }

                        // Chama as fun√ß√µes para buscar os dados com base na localiza√ß√£o
                        buscarClima(lat, lon, "resultado-local", true);
                        buscarPrevisao(lat, lon);
                        buscarComparacao(lat, lon); // Passa as coordenadas para buscarComparacao
                        buscarNomeCidadeEstado(lat, lon);
                    },
                    (error) => {
                        console.error('Erro ao obter localiza√ß√£o:', error);
                        document.getElementById('localizacao').innerText = 'N√£o foi poss√≠vel obter sua localiza√ß√£o.';
                    }
                );
            } else {
                document.getElementById('localizacao').innerText = 'Geolocaliza√ß√£o n√£o √© suportada pelo seu navegador.';
            }
        }

        // Fun√ß√£o para buscar sugest√µes de cidades
        function buscarSugestoes() {
            let cidade = document.getElementById('cidade').value;

            if (cidade.length < 2) {
                document.getElementById('sugestoes').innerHTML = '';
                return;
            }

            fetch(`http://localhost:8000/api/sugestoes?query=${cidade}`)
                .then(res => {
                    if (!res.ok) {
                        throw new Error(`Erro na requisi√ß√£o: ${res.status} ${res.statusText}`);
                    }
                    return res.json();
                })
                .then(data => {
                    if (data.length === 0) {
                        document.getElementById('sugestoes').innerHTML = '<li class="p-2 text-gray-500">Nenhuma cidade encontrada.</li>';
                        return;
                    }

                    let sugestoesHTML = data.map(cidade => `
                        <li class="p-2 cursor-pointer hover:bg-blue-100"
                            onclick="selecionarCidade(${cidade.lat}, ${cidade.lon}, '${cidade.name}', '${cidade.state || ''}', '${cidade.country}')">
                            ${cidade.name}, ${cidade.state || ''}, ${cidade.country}
                        </li>
                    `).join('');
                    document.getElementById('sugestoes').innerHTML = sugestoesHTML;
                })
                .catch(err => {
                    console.error("Erro ao buscar sugest√µes:", err);
                    document.getElementById('sugestoes').innerHTML = '<li class="p-2 text-red-500">Erro ao buscar sugest√µes.</li>';
                });
        }

        // Fun√ß√£o para selecionar uma cidade
        function selecionarCidade(lat, lon, nome, estado, pais) {
            // Atualiza o campo de entrada com o nome da cidade selecionada
            document.getElementById('cidade').value = `${nome}, ${estado}, ${pais}`;
            document.getElementById('sugestoes').innerHTML = '';

            // Chama as fun√ß√µes para buscar os dados da cidade selecionada
            buscarClima(lat, lon, "resultado-cidade");
            buscarPrevisao(lat, lon);
            buscarComparacao(lat, lon);
        }

        // Fun√ß√£o para buscar o clima atual
        async function buscarClima(lat, lon, resultadoId, isLocal = false) {
            if (!lat || !lon) {
                console.error('Coordenadas inv√°lidas fornecidas para buscarClima.');
                document.getElementById(resultadoId).innerHTML = `<p class="text-red-500">Erro: Coordenadas inv√°lidas.</p>`;
                return;
            }

            // Limpa o conte√∫do da div antes de buscar os novos dados
            document.getElementById(resultadoId).innerHTML = '';

            try {
                let respostaClima = await fetch(`http://localhost:8000/api/clima-atual?lat=${lat}&lon=${lon}`);
                let respostaSol = await fetch(`http://localhost:8000/api/nascer-por-sol?lat=${lat}&lon=${lon}`);

                if (!respostaClima.ok) {
                    throw new Error(`Erro na requisi√ß√£o do clima: ${respostaClima.status} ${respostaClima.statusText}`);
                }

                if (!respostaSol.ok) {
                    throw new Error(`Erro na requisi√ß√£o do nascer/p√¥r do sol: ${respostaSol.status} ${respostaSol.statusText}`);
                }

                let dadosClima = await respostaClima.json();
                let dadosSol = await respostaSol.json();

                if (dadosClima.error) {
                    throw new Error(dadosClima.error);
                }

                if (dadosSol.error) {
                    throw new Error(dadosSol.error);
                }

                const descricao = weatherDescriptions[dadosClima.weathercode] || "Condi√ß√£o desconhecida";

                // Fun√ß√£o para obter o √≠cone da dire√ß√£o do vento
                function getWindDirectionIcon(direction) {
                    if (direction >= 337.5 || direction < 22.5) return "‚¨ÜÔ∏è Norte";
                    if (direction >= 22.5 && direction < 67.5) return "‚ÜóÔ∏è Nordeste";
                    if (direction >= 67.5 && direction < 112.5) return "‚û°Ô∏è Leste";
                    if (direction >= 112.5 && direction < 157.5) return "‚ÜòÔ∏è Sudeste";
                    if (direction >= 157.5 && direction < 202.5) return "‚¨áÔ∏è Sul";
                    if (direction >= 202.5 && direction < 247.5) return "‚ÜôÔ∏è Sudoeste";
                    if (direction >= 247.5 && direction < 292.5) return "‚¨ÖÔ∏è Oeste";
                    if (direction >= 292.5 && direction < 337.5) return "‚ÜñÔ∏è Noroeste";
                }

                const direcaoVentoIcone = getWindDirectionIcon(dadosClima.winddirection);

                if (isLocal) {
                    document.getElementById('localizacao').innerText = `Clima Atual para sua localiza√ß√£o (${dadosClima.city || 'Local desconhecido'}, ${dadosClima.state || ''})`;
                }

                // Atualiza o elemento com os dados do clima
                document.getElementById(resultadoId).innerHTML = `
                    <div class="p-4 bg-gray-100 rounded-lg h-full flex flex-col justify-center">
                        <p><strong>Cidade:</strong> ${dadosClima.city || 'Local desconhecido'}, ${dadosClima.state || ''}</p>
                        <p><strong>Temperatura:</strong> ${dadosClima.temperature}¬∞C</p>
                        <p><strong>Umidade:</strong> ${dadosClima.humidity || 'N/A'}%</p>
                        <p><strong>Velocidade do Vento:</strong> ${dadosClima.windspeed} km/h</p>
                        <p><strong>Dire√ß√£o do Vento:</strong> ${direcaoVentoIcone}</p>
                        <p><strong>Condi√ß√£o:</strong> ${descricao}</p>
                        <p><strong>Nascer do Sol:</strong> ${new Date(dadosSol.nascer_do_sol).toLocaleTimeString('pt-BR')}</p>
                        <p><strong>P√¥r do Sol:</strong> ${new Date(dadosSol.por_do_sol).toLocaleTimeString('pt-BR')}</p>
                    </div>`;
            } catch (error) {
                console.error('Erro ao buscar o clima:', error);
                document.getElementById(resultadoId).innerHTML = `<p class="text-red-500">Erro ao buscar o clima: ${error.message}</p>`;
            }
        }

        // Fun√ß√£o para buscar a previs√£o de 7 dias
        async function buscarPrevisao(lat, lon) {
            if (!lat || !lon) {
                console.error('Coordenadas inv√°lidas fornecidas para buscarPrevisao.');
                document.getElementById('previsao-container').innerHTML = `<p class="text-red-500">Erro: Coordenadas inv√°lidas.</p>`;
                return;
            }

            try {
                let resposta = await fetch(`http://localhost:8000/api/previsao?lat=${lat}&lon=${lon}`);
                let dados = await resposta.json();

                if (dados.error) {
                    throw new Error(dados.error);
                }

                // Mapeia os c√≥digos de condi√ß√£o clim√°tica para √≠cones
                const weatherIcons = {
                    0: "‚òÄÔ∏è", // C√©u limpo
                    1: "üå§Ô∏è", // Principalmente limpo
                    2: "‚õÖ", // Parcialmente nublado
                    3: "‚òÅÔ∏è", // Nublado
                    45: "üå´Ô∏è", // Nevoeiro
                    48: "üå´Ô∏è‚ùÑÔ∏è", // Nevoeiro com geada
                    51: "üå¶Ô∏è", // Chuvisco leve
                    53: "üåßÔ∏è", // Chuvisco moderado
                    55: "üåßÔ∏è", // Chuvisco intenso
                    56: "üå®Ô∏è", // Chuvisco congelante leve
                    57: "üå®Ô∏è", // Chuvisco congelante intenso
                    61: "üåßÔ∏è", // Chuva leve
                    63: "üåßÔ∏è", // Chuva moderada
                    65: "üåßÔ∏è", // Chuva forte
                    66: "üå®Ô∏è", // Chuva congelante leve
                    67: "üå®Ô∏è", // Chuva congelante forte
                    71: "‚ùÑÔ∏è", // Neve leve
                    73: "‚ùÑÔ∏è", // Neve moderada
                    75: "‚ùÑÔ∏è", // Neve forte
                    77: "üå®Ô∏è", // Granizo
                    80: "üå¶Ô∏è", // Pancadas de chuva leves
                    81: "üå¶Ô∏è", // Pancadas de chuva moderadas
                    82: "üå¶Ô∏è", // Pancadas de chuva fortes
                    85: "‚ùÑÔ∏è", // Pancadas de neve leves
                    86: "‚ùÑÔ∏è", // Pancadas de neve fortes
                    95: "‚õàÔ∏è", // Tempestade leve ou moderada
                    96: "‚õàÔ∏è", // Tempestade com granizo leve
                    99: "‚õàÔ∏è", // Tempestade com granizo forte
                };

                // Vari√°veis para o carrossel
                const diasPorPagina = 3;
                let paginaAtual = 0;

                // Fun√ß√£o para renderizar os dias no carrossel
                function renderizarPrevisao() {
                    const inicio = paginaAtual * diasPorPagina;
                    const fim = inicio + diasPorPagina;
                    const diasExibidos = dados.time.slice(inicio, fim);

                    const previsaoHTML = diasExibidos.map((dia, index) => `
                        <div class="p-2 bg-gray-100 rounded-lg flex flex-col items-center space-y-2 w-80 h-50">
                            <span class="text-3xl">${weatherIcons[dados.weathercode[inicio + index]]}</span>
                            <div class="align-middle items-center">
                                <p>${new Date(dia).toLocaleDateString('pt-BR')}</p>
                                <p>M√°x: ${dados.temperature_2m_max[inicio + index]}¬∞C</p>
                                <p>M√≠n: ${dados.temperature_2m_min[inicio + index]}¬∞C</p>
                            </div>
                        </div>
                    `).join('');

                    document.getElementById('previsao-container').innerHTML = previsaoHTML;

                    // Exibe os bot√µes de navega√ß√£o ap√≥s o carregamento
                    document.getElementById('botoes-navegacao').classList.remove('hidden');
                }

                // Fun√ß√£o para navegar para a p√°gina anterior
                document.getElementById('prev-btn').onclick = () => {
                    if (paginaAtual > 0) {
                        paginaAtual--;
                        renderizarPrevisao();
                    }
                };

                // Fun√ß√£o para navegar para a pr√≥xima p√°gina
                document.getElementById('next-btn').onclick = () => {
                    if ((paginaAtual + 1) * diasPorPagina < dados.time.length) {
                        paginaAtual++;
                        renderizarPrevisao();
                    }
                };

                // Renderiza a previs√£o inicial
                renderizarPrevisao();
            } catch (error) {
                console.error('Erro ao buscar a previs√£o:', error);
                document.getElementById('previsao-container').innerHTML = `<p class="text-red-500">Erro ao buscar a previs√£o.</p>`;
            }
        }

        // Fun√ß√£o para buscar a compara√ß√£o de temperaturas
        async function buscarComparacao(lat, lon) {
            if (!lat || !lon) {
                console.error('Coordenadas inv√°lidas fornecidas para buscarComparacao.');
                document.getElementById('comparacao-container').innerHTML = `<p class="text-red-500">Erro: Coordenadas inv√°lidas.</p>`;
                return;
            }

            try {
                let resposta = await fetch(`http://localhost:8000/api/comparar-temperatura?lat=${lat}&lon=${lon}`);

                if (!resposta.ok) {
                    throw new Error(`Erro na requisi√ß√£o: ${resposta.status} ${resposta.statusText}`);
                }

                let dados = await resposta.json();

                if (dados.error) {
                    throw new Error(dados.error);
                }

                // Exibe os dados na tela
                document.getElementById('comparacao-container').innerHTML = `
                    <div class="p-4 bg-gray-100 rounded-lg h-full flex flex-col justify-center">
                        <p><strong>Ontem:</strong> ${dados.ontem}</p>
                        <p><strong>Hoje:</strong> ${dados.hoje}</p>
                        <p><strong>Compara√ß√£o:</strong> ${dados.comparacao}</p>
                    </div>`;
            } catch (error) {
                console.error('Erro ao buscar a compara√ß√£o de temperaturas:', error);
                document.getElementById('comparacao-container').innerHTML = `
                    <p class="text-red-500">Erro ao buscar a compara√ß√£o de temperaturas: ${error.message}</p>`;
            }
        }

        async function buscarNomeCidadeEstado(lat, lon) {
            if (!lat || !lon) {
                console.error('Coordenadas inv√°lidas fornecidas para buscarNomeCidadeEstado.');
                document.getElementById('localizacao').innerText = 'Erro: Coordenadas inv√°lidas.';
                return;
            }

            try {
                let resposta = await fetch(`http://localhost:8000/api/nome-cidade?lat=${lat}&lon=${lon}`);

                if (!resposta.ok) {
                    throw new Error(`Erro na requisi√ß√£o: ${resposta.status} ${resposta.statusText}`);
                }

                let dados = await resposta.json();

                if (dados.error) {
                    throw new Error(dados.error);
                }

                // Atualiza o elemento com o nome da cidade e do estado
                document.getElementById('localizacao').innerText = `Localiza√ß√£o: ${dados.cidade}, ${dados.estado || ''}`;
            } catch (error) {
                console.error('Erro ao buscar o nome da cidade:', error);
                document.getElementById('localizacao').innerText = 'Erro ao buscar o nome da cidade.';
            }
        }

        // Inicializa a geolocaliza√ß√£o ao carregar a p√°gina
        window.onload = obterLocalizacao;
    </script>
</body>
</html>
