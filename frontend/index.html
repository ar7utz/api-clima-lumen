<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <title>API de Clima</title>
</head>
<body class="bg-blue-200">
    <!-- Clima Atual com base na geolocalização -->
    <div id="clima-atual" class="absolute top-4 left-4 bg-white p-4 rounded-lg shadow-lg">
        <h1 class="text-lg font-bold">Clima Atual</h1>
        <p id="localizacao" class="text-gray-500 mb-2">Obtendo sua localização...</p>
        <div id="resultado-local" class="mt-2"></div>
    </div>

    <!-- Pesquisa de clima por cidade -->
    <div class="flex items-center justify-center h-screen">
        <div class="bg-white p-6 rounded-lg shadow-lg text-center w-96">
            <h1 class="text-xl font-bold">Pesquisar Clima</h1>
            <input id="cidade" type="text" placeholder="Digite o nome da cidade" class="border p-2 w-full mt-4 mb-4" oninput="buscarSugestoes()">
            <ul id="sugestoes" class="text-left border bg-white max-h-40 overflow-y-auto"></ul>
            <div id="resultado-cidade" class="mt-4"></div>
        </div>
    </div>

    <script>
        // Mapeamento de códigos de clima para descrições
        const weatherDescriptions = {
            0: "Céu limpo",
            1: "Principalmente limpo",
            2: "Parcialmente nublado",
            3: "Nublado",
            45: "Nevoeiro",
            48: "Nevoeiro com geada",
            51: "Chuvisco leve",
            53: "Chuvisco moderado",
            55: "Chuvisco intenso",
            61: "Chuva leve",
            63: "Chuva moderada",
            65: "Chuva forte",
            80: "Pancadas de chuva leves",
            81: "Pancadas de chuva moderadas",
            82: "Pancadas de chuva fortes",
        };

        // Função para obter a localização do usuário
        function obterLocalizacao() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;

                        // Atualiza a mensagem de localização
                        document.getElementById('localizacao').innerText = `Obtendo o clima para sua localização...`;

                        // Busca o clima com base na localização
                        buscarClima(lat, lon, "resultado-local", true);
                    },
                    (error) => {
                        console.error('Erro ao obter localização:', error);
                        document.getElementById('localizacao').innerText = 'Não foi possível obter sua localização.';
                    }
                );
            } else {
                document.getElementById('localizacao').innerText = 'Geolocalização não é suportada pelo seu navegador.';
            }
        }

        async function buscarNomeCidade(lat, lon, resultadoId, isLocal = false) {
            try {
                let resposta = await fetch(`https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&language=pt&format=json`);
                let dados = await resposta.json();

                if (!dados.results || dados.results.length === 0) {
                    throw new Error("Nenhum resultado encontrado.");
                }

                const nomeCidade = dados.results[0].name;
                const pais = dados.results[0].country;

                // Busca o clima passando a cidade e o país
                buscarClima(lat, lon, resultadoId, `${nomeCidade}, ${pais}`, isLocal);
            } catch (error) {
                console.error('Erro ao buscar o nome da cidade:', error);
                document.getElementById(resultadoId).innerHTML = `<p class="text-red-500">Erro ao buscar o nome da cidade.</p>`;
            }
        }


        // Função para buscar o clima com base na latitude e longitude
        async function buscarClima(lat, lon, resultadoId, nomeCidade = "Cidade desconhecida", isLocal = false) {
        try {
            let resposta = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=auto`);
            let dados = await resposta.json();

            // Exibe os dados do clima na página
            const clima = dados.current_weather;
            const descricao = weatherDescriptions[clima.weathercode] || "Condição desconhecida";

            // Atualiza a localização corretamente
            if (isLocal) {
                document.getElementById('localizacao').innerText = `Clima em ${nomeCidade}`;
            }

            document.getElementById(resultadoId).innerHTML = `
                <div class="p-4 bg-gray-100 rounded-lg">
                    <p class="font-bold text-lg">${nomeCidade}</p>
                    <p>Temperatura: <span class="font-semibold">${clima.temperature}°C</span></p>
                    <p>Velocidade do Vento: <span class="font-semibold">${clima.windspeed} km/h</span></p>
                    <p>Direção do Vento: <span class="font-semibold">${clima.winddirection}°</span></p>
                    <p>Condição: <span class="font-semibold">${descricao}</span></p>
                </div>`;
        } catch (error) {
            console.error('Erro ao buscar o clima:', error);
            document.getElementById(resultadoId).innerHTML = `<p class="text-red-500">Erro ao buscar o clima.</p>`;
        }
    }


        // Função para buscar sugestões de cidades enquanto o usuário digita
// Função para buscar sugestões de cidades enquanto o usuário digita
function buscarSugestoes() {
    let cidade = document.getElementById('cidade').value;

    if (cidade.length < 2) {
        document.getElementById('sugestoes').innerHTML = '';
        return;
    }

    // Faz a requisição para a rota do backend que busca sugestões
    fetch(`/api/sugestoes?query=${cidade}`)
        .then(res => res.json())
        .then(data => {
            if (data.length === 0) {
                document.getElementById('sugestoes').innerHTML = '<li class="p-2 text-gray-500">Nenhuma cidade encontrada.</li>';
                return;
            }

            let sugestoesHTML = data.map(cidade => `
                <li class="p-2 cursor-pointer hover:bg-blue-100"
                    onclick="selecionarCidade(${cidade.lat}, ${cidade.lon}, '${cidade.name}', '${cidade.state || ''}', '${cidade.country}')">
                    ${cidade.name}, ${cidade.state || ''}, ${cidade.country}
                </li>
            `).join('');
            document.getElementById('sugestoes').innerHTML = sugestoesHTML;
        })
        .catch(err => {
            console.error("Erro ao buscar sugestões:", err);
            document.getElementById('sugestoes').innerHTML = '<li class="p-2 text-red-500">Erro ao buscar sugestões.</li>';
        });
}

// Função para buscar o clima com base na latitude e longitude
async function buscarClima(lat, lon, resultadoId, nomeCidade = "Cidade desconhecida", isLocal = false) {
    try {
        // Faz a requisição para a rota do backend que busca o clima atual
        let resposta = await fetch(`/api/clima-atual?lat=${lat}&lon=${lon}`);
        let dados = await resposta.json();

        if (dados.error) {
            throw new Error(dados.error);
        }

        // Exibe os dados do clima na página
        const descricao = weatherDescriptions[dados.weathercode] || "Condição desconhecida";

        // Atualiza o nome da cidade se for a localização atual
        if (isLocal) {
            document.getElementById('localizacao').innerText = `Clima em ${nomeCidade}`;
        }

        document.getElementById(resultadoId).innerHTML = `
            <div class="p-4 bg-gray-100 rounded-lg">
                <p class="font-bold text-lg">${nomeCidade}</p>
                <p>Temperatura: <span class="font-semibold">${dados.temperature}°C</span></p>
                <p>Velocidade do Vento: <span class="font-semibold">${dados.windspeed} km/h</span></p>
                <p>Direção do Vento: <span class="font-semibold">${dados.winddirection}°</span></p>
                <p>Condição: <span class="font-semibold">${descricao}</span></p>
            </div>`;
    } catch (error) {
        console.error('Erro ao buscar o clima:', error);
        document.getElementById(resultadoId).innerHTML = `<p class="text-red-500">Erro ao buscar o clima.</p>`;
    }
}

        // Função para selecionar uma cidade e buscar o clima
        function selecionarCidade(lat, lon, nome, pais) {
            document.getElementById('cidade').value = `${nome}, ${pais}`; // Exibir cidade e país no input
            document.getElementById('sugestoes').innerHTML = ''; // Limpar sugestões
            buscarClima(lat, lon, "resultado-cidade", `${nome}, ${pais}`); // Buscar clima
        }


        // Chama a função para obter a localização ao carregar a página
        window.onload = obterLocalizacao;
    </script>
</body>
</html>
